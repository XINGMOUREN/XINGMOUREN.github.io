(()=>{const t="HappyKingCache",e="https://id.v3/";self.addEventListener("install",(()=>self.skipWaiting()));const n={happyking:{clean:!0,match:t=>"blog.happyking.top"===t.hostname&&t.pathname.match(/\.(woff2|woff|ttf|cur|js|css|png|mp3|svg|webp|jpg|jpeg)$/)},page:{clean:!0,match:t=>"blog.happyking.top"===t.hostname&&t.pathname.match(/\/$/)}},s=(t,e)=>{const n=(t=>{if(t.startsWith("https://cdn1.tianli0.top/npm")){const e=new URL(t);return[t,"https://cdn.jsdelivr.net/npm"+e.pathname,"https://npm.elemecdn.com"+e.pathname,"https://fastly.jsdelivr.net/npm"+e.pathname]}})(t.url);if(!n||!Promise.any)return fetch(t,{cache:e?"no-store":"default"});const s=n.map((e=>new Request(e,t))),r=[];return Promise.any(s.map(((t,e)=>fetch(t,{cache:"no-store",signal:(r[e]=new AbortController).signal}).then((t=>t.status<303?{index:e,response:t}:Promise.reject()))))).then((t=>{for(let e in r)e!=t.index&&r[e].abort();return t.response}))};function r(t){for(let e in n){const s=n[e];if(s.match(t))return s}return null}function a(){const t=[];this.push=e=>{t.push(e)},this.clean=e=>{t.length=0,e||this.push(e)},this.match=e=>{for(let n of t)if(n.match(e))return!0;return!1}}function i(t){const e=t=>{const e=r(new URL(t));return!e||e.clean},n=e=>{const n=t.value;if(Array.isArray(n)){for(let t of n)if(e(t))return!0;return!1}return e(n)};switch(t.flag){case"all":this.match=e;break;case"html":this.match=t=>t.match(/(\/|\/index\.html)$/);break;case"page":this.match=t=>n((e=>t.endsWith(`/${e}/`)||t.endsWith(`/${e}/index.html`)));break;case"file":this.match=t=>n((e=>t.endsWith(e)));break;case"str":this.match=t=>n((e=>t.includes(e)));break;case"reg":this.match=t=>n((e=>t.match(new RegExp(e,"i"))));break;default:throw`未知表达式：${JSON.stringify(t)}`}}self.addEventListener("fetch",(e=>{let n=e.request;if("GET"!==n.method)return;const a=(t=>{const e=t.url,n="//cdn.jsdelivr.net/";if(e.includes(n))return t.url=e.replace(n,"//cdn1.tianli0.top/"),!0})(n)||n,i=new URL(a.url);if(r(i)){const n=`${i.protocol}//${i.host}${i.pathname}`;e.respondWith(caches.match(n).then((e=>e||s(a,!0).then((e=>{if(e.status<303){const s=e.clone();caches.open(t).then((t=>t.put(n,s)))}return e})))))}else{const t=(t=>{if(t.startsWith("https://npm.elemecdn.com"))return{timeout:3e3,list:[t,`https://cdn.jsdelivr.net/npm${new URL(t).pathname}`]}})(a.url);t?e.respondWith(s(a,!1)):a!==n&&e.respondWith(fetch(a))}})),self.addEventListener("message",(n=>{"update"===n.data&&function(){const n=(t,e,n)=>{for(let s of e){const{version:e,change:r}=s;if(e===n)return!1;if(r)for(let e of r)t.push(new i(e))}return!0},r=s=>{const r={write:n=>caches.open(t).then((t=>t.put(e,new Response(JSON.stringify(n))))),read:()=>caches.match(e).then((t=>t?.json()))};let h=new a;return r.read().then((t=>{const{info:e,global:a}=s,c=0,o={global:a,local:e[0].version,escape:c};if(!t)return r.write(o),o;let l=0!==c&&c!==t.escape||n(h,e,t.local);return r.write(o),l&&(a===t.global?h.clean(new i({flag:"all"})):h.refresh=!0),{list:h,version:o}}))};return s(new Request("/update.json"),!1).then((n=>{if(n.ok||301===n.status||302===n.status)return n.json().then((n=>r(n).then((n=>{return n.list?(s=n.list,caches.open(t).then((t=>t.keys().then((n=>Promise.all(n.map((async n=>{const r=n.url;return r!==e&&s.match(r)?(t.delete(n),r):null}))))).then((t=>t.filter((t=>t))))))).then((t=>({list:t,version:n.version}))):{version:n};var s}))));throw`加载 update.json 时遇到异常，状态码：${n.status}`}))}().then((t=>n.source.postMessage({type:"update",update:t.list,version:t.version})))}))})();